;; test basic asserts
!(assert (= 1 1))
!(assert-eq (+ 2 1) (+ 1 2))
!(assert-error (/ 1 0))
!(assert-emitted '(1 2) (begin (emit 1) (emit 2)))

;; test nested loading
!(load "loaded.lurk")
!(assert-eq loaded-nested :loaded-nested)
!(assert-eq loaded :loaded)

;; test defrec
!(defrec sum (lambda (l) (if (eq l nil) 0 (+ (car l) (sum (cdr l))))))
!(assert-eq (sum '(1 2 3)) 6)

;; test env manipulation
!(clear)
!(assert-error sum)
!(set-env (eval '(let ((a 1) (b 2)) (current-env))))
!(assert-eq a 1)
!(erase-from-env a)
!(assert-error a)
!(assert-eq b 2)

;; test help meta command
!(help)
!(help hide)
!(help open)
!(help commit)

;; test hide/commit
!(hide (bignum (commit 123)) 42)
!(commit 42)

;; test calling functional commitments
!(call (lambda (x) x) 0)
!(commit (eval '(lambda (x) x)))
!(call #0x3f2e7102a9f8a303255b90724f24f4eb05b61e99723ca838cf30671676c86a 0)
!(call (comm #0x3f2e7102a9f8a303255b90724f24f4eb05b61e99723ca838cf30671676c86a) 0)

;; test chain and transition
!(commit (eval '(letrec ((add (lambda (counter x)
                       (let ((counter (+ counter x)))
                         (cons counter (commit (add counter)))))))
               (add 0))))
!(chain #0x8ef25bc2228ca9799db65fd2b137a7b0ebccbfc04cf8530133e60087d403db 1)

!(def state0 (cons nil (comm #0x8ef25bc2228ca9799db65fd2b137a7b0ebccbfc04cf8530133e60087d403db)))
!(transition state1 state0 1)
!(assert-eq (car state1) 1)
!(fetch #0x385d186d86be8b23b1784c339e7a9b601e3d69012a7d77923d0d2f69274287)
!(transition state2 state1 4)
!(assert-eq (car state2) 5)
!(assert-eq (cdr state2) (comm #0x6b2984a56dc2bbb61495c6fdf8076f0debf10ab2ae43aa1de45de64b460141))
!(fetch (comm #0x6b2984a56dc2bbb61495c6fdf8076f0debf10ab2ae43aa1de45de64b460141))

!(clear)
!(commit (eval '(letrec ((add (lambda (counter x)
                       (let ((counter (+ counter x)))
                         (cons counter (bignum (commit (add counter))))))))
               (add 0))))

!(def state0 (cons nil #0x5c438d9aaadaaaa1f7ee1a5f3deaa400c29cbf1ab51240e667c1120a5ca0f8))
!(transition state1 state0 1)
!(assert-eq (car state1) 1)
!(fetch #0x185d8872fcbe43a7a7d785fcd5cf0ccd80e1dbe601d36d447eb852190ead80)
!(transition state2 state1 4)
!(assert-eq (car state2) 5)
!(assert-eq (cdr state2) #0xb81cb9209faa8d633089d3038f44ab7f50e06d21540f3630f25a510156c92)
!(fetch #0xb81cb9209faa8d633089d3038f44ab7f50e06d21540f3630f25a510156c92)

;; test packages
!(defpackage abc)
!(in-package abc)
!(def two (.lurk.+ 1 1))
!(in-package .lurk.user)
!(assert-eq .lurk.user.abc.two 2)
!(import .lurk.user.abc.two)
!(assert-eq two 2)

;; test dump-expr/load-expr
!(dump-expr (+ 1 1) "repl-test-two")
!(load-expr two "repl-test-two")
!(assert-eq two 2)
